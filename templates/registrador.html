<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Panel Registrador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Agrega el cliente de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // Configura tu cliente Supabase aquí
        const supabase = window.supabase.createClient(
            'https://wgczmcheqqffemfxfudc.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnY3ptY2hlcXFmZmVtZnhmdWRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2OTE3MDQsImV4cCI6MjA2NzI2NzcwNH0.lXpXV7cHp7s_4pbSJRarzTKNCR9Aj9if714ncEyKRZs'
        );
        // Prueba de conexión
        supabase
            .from('vehiculos')
            .select('*')
            .then(res => console.log("Prueba Supabase:", res))
            .catch(err => console.error("Error Supabase:", err));
        // Función para subir imagen a Supabase Storage
        async function subirImagenASupabase(file, nombreArchivo) {
            const { data, error } = await supabase.storage
                .from('vehiculos')
                .upload(nombreArchivo, file, { upsert: true });
            if (error) {
                alert("Error al subir imagen: " + error.message);
                return null;
            }
            const { data: publicUrlData } = supabase
                .storage
                .from('vehiculos')
                .getPublicUrl(nombreArchivo);
            return publicUrlData.publicUrl;
        }
    </script>
</head>

<body class="bg-gray-100 min-h-screen">
    <!-- Navbar -->
    <nav class="w-full bg-blue-700 text-white flex items-center justify-between px-4 py-3 fixed top-0 left-0 z-50">
        <a href="/" class="font-bold text-lg">Combustible</a>
        <a href="/logout"
            class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded transition text-xs sm:text-sm font-semibold">Cerrar
            sesión</a>
    </nav>

    <div class="max-w-3xl mx-auto pt-24 pb-8 px-2 sm:px-4">
        <h1 class="text-xl sm:text-2xl font-bold text-blue-700 mb-6 text-center">Panel del Registrador</h1>
        <!-- Barra de búsqueda -->
        <div class="flex flex-col sm:flex-row gap-2 mb-6">
            <input id="busqueda" type="text" placeholder="Buscar por nombre, placa o CI..."
                class="flex-1 px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm sm:text-base">
            <div class="flex gap-2">
                <button id="buscarBtn"
                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 text-sm sm:text-base">Buscar</button>
                <button id="nuevoBtn"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm sm:text-base">Nuevo</button>
                <button id="actualizarBtn"
                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 text-sm sm:text-base">Actualizar</button>
            </div>
        </div>
        <!-- Resultados -->
        <div id="resultados" class="space-y-4"></div>
        <div id="noRegistros" class="text-center text-gray-500 mt-8 hidden text-sm sm:text-base">No existen registros
        </div>
    </div>

    <!-- Modal de registro -->
    <div id="modalRegistro" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white rounded-lg shadow-lg w-full max-w-lg mx-2 sm:mx-auto overflow-y-auto max-h-[95vh] relative">
            <button onclick="cerrarModal()"
                class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            <div class="p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-bold mb-4 text-blue-700">Registrar nuevo cliente</h2>
                <form id="registroForm" class="space-y-4">
                    <!-- Persona -->
                    <div>
                        <label class="block font-semibold mb-1 text-sm sm:text-base">Nombre completo</label>
                        <input name="nombre" type="text" class="w-full border px-3 py-2 rounded text-sm sm:text-base"
                            required>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1 text-sm sm:text-base">CI</label>
                        <input name="ci" type="text" class="w-full border px-3 py-2 rounded text-sm sm:text-base"
                            required>
                    </div>
                    <div>
                        <label class="inline-flex items-center text-sm sm:text-base">
                            <input type="checkbox" id="funcionarioCheck" class="mr-2"> ¿Funcionario público?
                        </label>
                    </div>
                    <div id="credencialDiv" class="hidden">
                        <label class="block font-semibold mb-1 text-sm sm:text-base">N° Credencial</label>
                        <input name="numero_credencial" type="text"
                            class="w-full border px-3 py-2 rounded text-sm sm:text-base">
                    </div>
                    <!-- Vehículo -->
                    <hr>
                    <div>
                        <label class="block font-semibold mb-1 text-sm sm:text-base">N° Chasis</label>
                        <input name="numero_crasis" type="text"
                            class="w-full border px-3 py-2 rounded text-sm sm:text-base" required>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1 text-sm sm:text-base">Placa</label>
                        <input name="placa" type="text" class="w-full border px-3 py-2 rounded text-sm sm:text-base"
                            required>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1 text-sm sm:text-base">Tipo</label>
                        <select name="tipo" class="w-full border px-3 py-2 rounded text-sm sm:text-base" required>
                            <option value="">Selecciona tipo</option>
                            <option value="auto">Auto</option>
                            <option value="motocicleta">Motocicleta</option>
                            <option value="motocar">Motocar</option>
                            <option value="camion">Camión</option>
                        </select>
                    </div>
                    <div>
                        <label class="inline-flex items-center text-sm sm:text-base">
                            <input type="checkbox" id="institucionalCheck" class="mr-2"> ¿Vehículo institucional?
                        </label>
                    </div>
                    <div id="institucionDiv" class="hidden">
                        <label class="block font-semibold mb-1 text-sm sm:text-base">Nombre Institución</label>
                        <input name="nombre_institucion" type="text"
                            class="w-full border px-3 py-2 rounded text-sm sm:text-base">
                    </div>
                    <!-- Foto -->
                    <hr>
                    <div>
                        <label class="block font-semibold mb-1 text-sm sm:text-base">Foto del vehículo</label>
                        <input name="foto" type="file" accept="image/*" capture="environment"
                            class="w-full text-sm sm:text-base">
                        <img id="previewFoto" src="https://placehold.co/120x80?text=Sin+foto" alt="Preview"
                            class="mt-2 w-24 h-16 sm:w-32 sm:h-20 object-cover rounded border">
                    </div>
                    <div id="registroError" class="text-red-600 text-xs sm:text-sm"></div>
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm sm:text-base">Guardar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de carga de combustible -->
    <div id="modalCarga" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white rounded-lg shadow-lg w-full max-w-md mx-2 sm:mx-auto overflow-y-auto max-h-[95vh] relative">
            <button onclick="cerrarModalCarga()"
                class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            <div class="p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-bold mb-4 text-green-700">Registrar carga de combustible</h2>
                <form id="cargaForm" class="space-y-4">
                    <div>
                        <label class="block font-semibold mb-1 text-sm sm:text-base">Estación</label>
                        <select name="estacion_id" id="cargaEstacion"
                            class="w-full border px-3 py-2 rounded text-sm sm:text-base" required>
                            <option value="">Selecciona estación</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1 text-sm sm:text-base">Cantidad (litros)</label>
                        <input name="cantidad" type="number" min="1" step="1" placeholder="Ej: 10"
                            class="w-full border px-3 py-2 rounded text-sm sm:text-base" required>
                    </div>
                    <div id="cargaError" class="text-red-600 text-xs sm:text-sm"></div>
                    <button type="submit"
                        class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 text-sm sm:text-base">Guardar
                        carga</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Mensaje de éxito -->
    <div id="mensajeExito"
        class="fixed top-6 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded shadow-lg hidden z-50 text-sm sm:text-base">
        ¡Registro guardado correctamente!
    </div>

    <script>
        // Mostrar/ocultar campos en el modal
        document.getElementById('funcionarioCheck').addEventListener('change', function () {
            document.getElementById('credencialDiv').classList.toggle('hidden', !this.checked);
        });
        document.getElementById('institucionalCheck').addEventListener('change', function () {
            document.getElementById('institucionDiv').classList.toggle('hidden', !this.checked);
        });

        // Preview de foto
        document.querySelector('input[name="foto"]').addEventListener('change', function (e) {
            const file = e.target.files[0];
            const preview = document.getElementById('previewFoto');
            if (file) {
                const reader = new FileReader();
                reader.onload = function (ev) { preview.src = ev.target.result; }
                reader.readAsDataURL(file);
            } else {
                preview.src = "https://placehold.co/120x80?text=Sin+foto";
            }
        });
        //boton de actualizar la pagina
        document.getElementById('actualizarBtn').onclick = cargarRegistros;
        // Abrir/cerrar modal
        document.getElementById('nuevoBtn').onclick = function () {
            document.getElementById('modalRegistro').classList.remove('hidden');
            document.getElementById('registroForm').reset();
            document.getElementById('previewFoto').src = "https://placehold.co/120x80?text=Sin+foto";
            document.getElementById('credencialDiv').classList.add('hidden');
            document.getElementById('institucionDiv').classList.add('hidden');
            document.getElementById('registroError').innerText = '';
        };
        function cerrarModal() {
            document.getElementById('modalRegistro').classList.add('hidden');
        }

        // --- NUEVO: Cargar registros existentes al iniciar ---
        let registros = [];
        let cargasCombustible = [];
        let estaciones = [];
        async function cargarEstacionesComboBox() {
            const select = document.getElementById('cargaEstacion');
            select.innerHTML = '<option value="">Selecciona estación</option>';
            try {
                const response = await fetch('/estaciones');
                estaciones = await response.json();
                estaciones.forEach(e => {
                    select.innerHTML += `<option value="${e.id}">${e.nombre}</option>`;
                });
            } catch (err) {
                select.innerHTML += '<option value="">Error cargando estaciones</option>';
            }
        }

        async function cargarRegistros() {
            // Trae todas las relaciones persona-vehiculo
            const relaciones = await fetch('/personas_vehiculos').then(r => r.json());
            const personas = await fetch('/personas').then(r => r.json());
            const vehiculos = await fetch('/vehiculos').then(r => r.json());
            const funcionarios = await fetch('/funcionarios_publicos').then(r => r.json());
            const institucionales = await fetch('/vehiculos_institucionales').then(r => r.json());
            const now = new Date();
            const mesActual = now.getMonth();
            const anioActual = now.getFullYear();
            cargasCombustible = await fetch('/cargas_combustible').then(r => r.json());
            estaciones = await fetch('/estaciones').then(r => r.json());

            registros = relaciones.map(rel => {
                const persona = personas.find(p => p.id === rel.persona_id);
                const vehiculo = vehiculos.find(v => v.id === rel.vehiculo_id);
                const funcionario = funcionarios.find(f => f.persona_id === persona?.id);
                const institucional = institucionales.find(i => i.vehiculo_id === vehiculo?.id);

                // Buscar última carga de este vehículo
                const cargasVehiculo = cargasCombustible.filter(c => c.vehiculo_id === vehiculo?.id);
                let ultima_carga = null;
                if (cargasVehiculo.length > 0) {
                    const carga = cargasVehiculo.reduce((a, b) => new Date(a.fecha) > new Date(b.fecha) ? a : b);
                    const estacionObj = estaciones.find(e => e.id == carga.estacion_id);
                    ultima_carga = {
                        cantidad: carga.cantidad,
                        estacion_nombre: estacionObj ? estacionObj.nombre : '-',
                        fecha: carga.fecha ? new Date(carga.fecha).toLocaleString() : ''
                    };
                }

                // Calcular total cargado en el mes por la persona (en todos sus vehículos)
                const relacionesPersona = relaciones.filter(r => r.persona_id === persona?.id);
                const vehiculosPersona = relacionesPersona.map(r => r.vehiculo_id);
                const cargasMes = cargasCombustible.filter(c =>
                    vehiculosPersona.includes(c.vehiculo_id) &&
                    new Date(c.fecha).getMonth() === mesActual &&
                    new Date(c.fecha).getFullYear() === anioActual
                );
                const totalMes = cargasMes.reduce((sum, c) => sum + Number(c.cantidad), 0);

                return {
                    nombre: persona?.nombre || '',
                    ci: persona?.ci || '',
                    es_funcionario: !!funcionario,
                    numero_credencial: funcionario?.numero_credencial || '',
                    numero_crasis: vehiculo?.numero_crasis || '',
                    placa: vehiculo?.placa || '',
                    tipo: vehiculo?.tipo || '',
                    es_institucional: !!institucional,
                    nombre_institucion: institucional?.nombre_institucion || '',
                    foto: vehiculo?.foto || null,
                    vehiculo_id: vehiculo?.id,
                    verificado: vehiculo?.verificado || false,
                    ultima_carga,
                    total_cargado_mes: totalMes,
                    restante_mes: Math.max(0, 119 - totalMes)
                };
            });
            mostrarRegistros(registros);
        }

        function mostrarRegistros(lista) {
            const resultados = document.getElementById('resultados');
            resultados.innerHTML = '';
            if (lista.length === 0) {
                document.getElementById('noRegistros').classList.remove('hidden');
            } else {
                document.getElementById('noRegistros').classList.add('hidden');
                lista.forEach(data => mostrarTarjeta(data, false));
            }
        }

        // Mostrar tarjeta de registro debajo de la barra de búsqueda
        function mostrarTarjeta(data, prepend = true) {
            const resultados = document.getElementById('resultados');
            const fotoUrl = data.foto || "https://placehold.co/120x80?text=Sin+foto";
            let leyenda = '';
            if (data.verificado) {
                leyenda = '<span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold mb-2">Verificado</span>';
            } else {
                leyenda = '<span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-semibold mb-2">Verificación pendiente</span>';
            }
            // Solo puede cargar si está verificado y no superó el límite mensual
            const puedeCargar = data.verificado && data.restante_mes > 0;
            const disabled = puedeCargar ? '' : 'disabled style="opacity:0.5;cursor:not-allowed;"';
            const tarjeta = document.createElement('div');
            tarjeta.className = "bg-white rounded shadow flex flex-col sm:flex-row gap-4 p-4 items-center relative";
            tarjeta.innerHTML = `
            ${leyenda}
            <img src="${fotoUrl}" alt="Foto" class="w-44 h-32 sm:w-56 sm:h-40 object-cover rounded border mb-2 sm:mb-0">
            <div class="flex-1 w-full">
                <div class="font-bold text-base sm:text-lg">${data.nombre} (${data.ci})</div>
                <div class="text-gray-600 text-sm sm:text-base">${data.es_funcionario ? 'Funcionario Público, Credencial: ' + data.numero_credencial : 'No funcionario'}</div>
                <div class="mt-1 text-sm sm:text-base">Vehículo: <span class="font-semibold">${data.placa}</span> (${data.tipo})<br>
                N° Chasis: ${data.numero_crasis} ${data.es_institucional ? '<br>Institucional: ' + data.nombre_institucion : ''}</div>
                <div class="mt-1 text-xs sm:text-sm text-blue-700">
                    Cargado este mes: <span class="font-semibold">${data.total_cargado_mes} L</span> /
                    <span class="font-semibold">119 L</span><br>
                    Restante: <span class="font-semibold">${data.restante_mes} L</span>
                </div>
                <div class="mt-1 carga-info"></div>
                <button class="bg-green-600 text-white px-3 py-1 rounded mt-2 text-xs sm:text-sm cargar-btn" ${disabled}>Cargar</button>
            </div>
        `;
            // Botón cargar
            tarjeta.querySelector('.cargar-btn').onclick = function () {
                if (puedeCargar) {
                    abrirModalCarga(data.vehiculo_id, tarjeta);
                }
            };
            // Mostrar última carga si existe
            if (data.ultima_carga) {
                tarjeta.querySelector('.carga-info').innerHTML = `
            <div class="mt-2 text-xs sm:text-sm text-green-700">
                Última carga: ${data.ultima_carga.cantidad} L en ${data.ultima_carga.estacion_nombre} (${data.ultima_carga.fecha})
            </div>
        `;
            }
            if (prepend) {
                resultados.prepend(tarjeta);
            } else {
                resultados.appendChild(tarjeta);
            }
        }

        // Modal cargar
        let cargaVehiculoId = null;
        let cargaTarjetaDiv = null;
        function abrirModalCarga(vehiculo_id, tarjetaDiv) {
            cargaVehiculoId = vehiculo_id;
            cargaTarjetaDiv = tarjetaDiv;
            cargarEstacionesComboBox();
            document.getElementById('cargaForm').reset();
            document.getElementById('cargaError').innerText = '';
            document.getElementById('modalCarga').classList.remove('hidden');
        }
        function cerrarModalCarga() {
            document.getElementById('modalCarga').classList.add('hidden');
        }

        // Guardar carga de combustible
        document.getElementById('cargaForm').onsubmit = async function (e) {
            e.preventDefault();
            const estacion_id = this.estacion_id.value;
            const cantidad = this.cantidad.value;
            if (!cargaVehiculoId || !estacion_id || !cantidad) {
                document.getElementById('cargaError').innerText = "Completa todos los campos.";
                return;
            }
            if (!/^\d+$/.test(cantidad) || parseInt(cantidad) < 1) {
                document.getElementById('cargaError').innerText = "Ingresa un valor entero positivo.";
                return;
            }
            let res = await fetch('/cargas_combustible', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    vehiculo_id: cargaVehiculoId,
                    estacion_id: estacion_id,
                    cantidad: parseInt(cantidad, 10)
                })
            });
            if (!res.ok) {
                document.getElementById('cargaError').innerText = "Error al guardar la carga.";
                return;
            }
            cerrarModalCarga();
            // Recarga los registros para actualizar los litros cargados y el botón
            await cargarRegistros();
        };
        // Buscar por nombre, placa o CI
        function filtrarRegistros() {
            const q = document.getElementById('busqueda').value.trim().toLowerCase();
            const filtrados = registros.filter(data =>
                data.nombre.toLowerCase().includes(q) ||
                data.ci.toLowerCase().includes(q) ||
                data.placa.toLowerCase().includes(q)
            );
            mostrarRegistros(filtrados);
        }
        document.getElementById('busqueda').addEventListener('input', filtrarRegistros);
        document.getElementById('buscarBtn').addEventListener('click', filtrarRegistros);

        // Guardar registro (con subida de imagen a Supabase)
        document.getElementById('registroForm').onsubmit = async function (e) {
            e.preventDefault();
            const form = e.target;
            const nombre = form.nombre.value.trim();
            const ci = form.ci.value.trim();
            const es_funcionario = document.getElementById('funcionarioCheck').checked;
            const numero_credencial = form.numero_credencial.value.trim();
            const numero_crasis = form.numero_crasis.value.trim();
            const placa = form.placa.value.trim();
            const tipo = form.tipo.value;
            const es_institucional = document.getElementById('institucionalCheck').checked;
            const nombre_institucion = form.nombre_institucion.value.trim();
            const fotoInput = form.foto;
            const foto = fotoInput.files[0];

            // Validaciones básicas
            if (!nombre || !ci || !numero_crasis || !placa || !tipo) {
                document.getElementById('registroError').innerText = "Completa todos los campos obligatorios.";
                return;
            }
            if (es_funcionario && !numero_credencial) {
                document.getElementById('registroError').innerText = "Ingresa el número de credencial.";
                return;
            }
            if (es_institucional && !nombre_institucion) {
                document.getElementById('registroError').innerText = "Ingresa el nombre de la institución.";
                return;
            }

            // 1. Crear persona
            let personaRes = await fetch('/personas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, ci })
            });
            if (!personaRes.ok) {
                const errorText = await personaRes.text();
                document.getElementById('registroError').innerText = "Error al crear persona: " + errorText;
                return;
            }
            const persona = await personaRes.json();

            // 2. Si es funcionario, crear funcionario_publico
            if (es_funcionario) {
                let funcRes = await fetch('/funcionarios_publicos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ persona_id: persona.id, numero_credencial })
                });
                if (!funcRes.ok) {
                    const errorText = await funcRes.text();
                    document.getElementById('registroError').innerText = "Error al crear funcionario público: " + errorText;
                    return;
                }
            }

            // 3. Subir imagen a Supabase Storage antes de crear el vehículo
            let fotoUrl = null;
            if (foto) {
                const nombreArchivo = `vehiculo_${Date.now()}_${placa}.jpg`;
                fotoUrl = await subirImagenASupabase(foto, nombreArchivo);
                if (!fotoUrl) {
                    document.getElementById('registroError').innerText = "Error al subir la imagen.";
                    return;
                }
            }

            // 4. Crear vehículo (ahora incluye foto)
            let vehiculoRes = await fetch('/vehiculos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numero_crasis, placa, tipo, foto: fotoUrl })
            });
            if (!vehiculoRes.ok) {
                const errorText = await vehiculoRes.text();
                document.getElementById('registroError').innerText = "Error al crear vehículo: " + errorText;
                return;
            }
            const vehiculo = await vehiculoRes.json();

            // 5. Si es institucional, crear vehiculo_institucional
            if (es_institucional) {
                let instRes = await fetch('/vehiculos_institucionales', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vehiculo_id: vehiculo.id, nombre_institucion })
                });
                if (!instRes.ok) {
                    document.getElementById('registroError').innerText = "Error al crear vehículo institucional.";
                    return;
                }
            }

            // 6. Relacionar persona y vehículo (con restricciones)
            let relRes = await fetch('/personas_vehiculos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ persona_id: persona.id, vehiculo_id: vehiculo.id })
            });
            if (!relRes.ok) {
                const data = await relRes.json();
                document.getElementById('registroError').innerText = data.error || "Error al asociar persona y vehículo.";
                return;
            }

            // 7. Mostrar mensaje de éxito y cerrar modal
            cerrarModal();
            document.getElementById('mensajeExito').classList.remove('hidden');
            setTimeout(() => document.getElementById('mensajeExito').classList.add('hidden'), 2000);
            // 8. Recargar todos los registros desde el backend para reflejar el estado real
            await cargarRegistros();
        };

        window.addEventListener('DOMContentLoaded', cargarRegistros);
    </script>
</body>

</html>