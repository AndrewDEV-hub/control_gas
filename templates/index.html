<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CRUD General</title>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>CRUD Personas</h1>
    <form id="personaForm">
        <input type="text" name="ci" placeholder="CI" required>
        <input type="text" name="nombre" placeholder="Nombre" required>
        <label>
            <input type="checkbox" id="funcionarioCheck"> ¿Funcionario público?
        </label>
        <button type="submit">Agregar Persona</button>
    </form>
    <!-- Modal Funcionario Público -->
    <div id="modalFuncionario" class="modal">
        <div class="modal-content">
            <h3>Datos de Funcionario Público</h3>
            <label>N° Credencial: <input type="text" id="modal_numero_credencial"></label>
            <br><br>
            <button type="button" onclick="guardarFuncionario()">Guardar</button>
            <button type="button" onclick="cerrarModal('modalFuncionario')">Cancelar</button>
        </div>
    </div>
    <h2>Lista de personas</h2>
    <ul id="personasList">
        <!-- Se llena por JS -->
    </ul>

    <hr>

    <h1>CRUD Usuarios</h1>
    <form id="usuarioForm">
        <input type="text" name="nombre" placeholder="Nombre" required>
        <input type="text" name="rol" placeholder="Rol" required>
        <button type="submit">Agregar Usuario</button>
    </form>
    <h2>Lista de usuarios</h2>
    <ul id="usuariosList">
        <!-- Se llena por JS -->
    </ul>

    <hr>

    <h1>CRUD Vehículos</h1>
    <form id="vehiculoForm">
        <input type="text" name="numero_crasis" placeholder="Número Crasis" required>
        <input type="text" name="placa" placeholder="Placa" required>
        <label>
            Tipo:
            <select name="tipo" required>
                <option value="auto">Auto</option>
                <option value="motocicleta">Motocicleta</option>
                <option value="motocar">Motocar</option>
                <option value="camion">Camión</option>
            </select>
        </label>
        <label>
            <input type="checkbox" id="institucionalCheck"> ¿Vehículo institucional?
        </label>
        <button type="submit">Agregar Vehículo</button>
    </form>
    <!-- Modal Vehículo Institucional -->
    <div id="modalInstitucional" class="modal">
        <div class="modal-content">
            <h3>Datos de Vehículo Institucional</h3>
            <label>Nombre Institución: <input type="text" id="modal_nombre_institucion"></label>
            <br><br>
            <button type="button" onclick="guardarInstitucional()">Guardar</button>
            <button type="button" onclick="cerrarModal('modalInstitucional')">Cancelar</button>
        </div>
    </div>
    <h2>Lista de vehículos</h2>
    <ul id="vehiculosList">
        <!-- Se llena por JS -->
    </ul>

    <hr>

    <h1>CRUD Estaciones</h1>
    <form id="estacionForm">
        <input type="text" name="nombre" placeholder="Nombre" required>
        <input type="text" name="ubicacion" placeholder="Ubicación" required>
        <button type="submit">Agregar Estación</button>
    </form>
    <h2>Lista de estaciones</h2>
    <ul id="estacionesList">
        <!-- Se llena por JS -->
    </ul>

    <!-- Asociar persona a vehículo -->
    <hr>
    <h1>Asociar Persona a Vehículo</h1>
    <form id="asociarForm">
        <label>
            Persona:
            <select id="asociar_persona" required></select>
        </label>
        <label>
            Vehículo:
            <select id="asociar_vehiculo" required></select>
        </label>
        <button type="submit">Asociar</button>
    </form>
    <div id="asociarError" style="color:red;"></div>
    <h2>Relaciones Persona-Vehículo</h2>
    <ul id="relacionesList">
        <!-- Se llena por JS -->
    </ul>

    <script>
        let personaTemp = null;
        let vehiculoTemp = null;

        function abrirModal(id) {
            document.getElementById(id).style.display = 'block';
        }
        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
            personaTemp = null;
            vehiculoTemp = null;
        }

        // Cargar y mostrar listas
        async function cargarListas() {
            // Personas y funcionarios
            const personas = await fetch('/personas').then(r => r.json());
            const funcionarios = await fetch('/funcionarios_publicos').then(r => r.json());
            let personasHtml = '';
            personas.forEach(p => {
                const func = funcionarios.find(f => f.persona_id === p.id);
                personasHtml += `<li>${p.ci} - ${p.nombre} ${func ? '(Funcionario Público, Credencial: ' + func.numero_credencial + ')' : '(No funcionario)'}
            <form method="post" action="/eliminar/${p.id}" style="display:inline;">
                <button type="submit">Eliminar</button>
            </form>
        </li>`;
            });
            document.getElementById('personasList').innerHTML = personasHtml;

            // Usuarios
            const usuarios = await fetch('/usuarios').then(r => r.json());
            let usuariosHtml = '';
            usuarios.forEach(u => {
                usuariosHtml += `<li>${u.nombre} - ${u.rol}
            <form method="post" action="/eliminar_usuario/${u.id}" style="display:inline;">
                <button type="submit">Eliminar</button>
            </form>
        </li>`;
            });
            document.getElementById('usuariosList').innerHTML = usuariosHtml;

            // Vehículos e institucionales
            const vehiculos = await fetch('/vehiculos').then(r => r.json());
            const institucionales = await fetch('/vehiculos_institucionales').then(r => r.json());
            let vehiculosHtml = '';
            vehiculos.forEach(v => {
                const inst = institucionales.find(i => i.vehiculo_id === v.id);
                vehiculosHtml += `<li>${v.numero_crasis} - ${v.placa} - ${v.tipo} ${inst ? '(Institucional: ' + inst.nombre_institucion + ')' : '(No institucional)'}
            <form method="post" action="/eliminar_vehiculo/${v.id}" style="display:inline;">
                <button type="submit">Eliminar</button>
            </form>
        </li>`;
            });
            document.getElementById('vehiculosList').innerHTML = vehiculosHtml;

            // Estaciones
            const estaciones = await fetch('/estaciones').then(r => r.json());
            let estacionesHtml = '';
            estaciones.forEach(e => {
                estacionesHtml += `<li>${e.nombre} - ${e.ubicacion}
            <form method="post" action="/eliminar_estacion/${e.id}" style="display:inline;">
                <button type="submit">Eliminar</button>
            </form>
        </li>`;
            });
            document.getElementById('estacionesList').innerHTML = estacionesHtml;

            // Opciones para asociar persona y vehículo
            let personaOptions = '';
            personas.forEach(p => {
                personaOptions += `<option value="${p.id}">${p.ci} - ${p.nombre}</option>`;
            });
            let vehiculoOptions = '';
            vehiculos.forEach(v => {
                vehiculoOptions += `<option value="${v.id}">${v.numero_crasis} - ${v.placa} - ${v.tipo}</option>`;
            });
            document.getElementById('asociar_persona').innerHTML = personaOptions;
            document.getElementById('asociar_vehiculo').innerHTML = vehiculoOptions;

            // Mostrar relaciones
            const relaciones = await fetch('/personas_vehiculos').then(r => r.json());
            let relacionesHtml = '';
            relaciones.forEach(rel => {
                const persona = personas.find(p => p.id === rel.persona_id);
                const vehiculo = vehiculos.find(v => v.id === rel.vehiculo_id);
                relacionesHtml += `<li>${persona ? persona.nombre : 'Desconocido'} ↔ ${vehiculo ? vehiculo.placa : 'Desconocido'}</li>`;
            });
            document.getElementById('relacionesList').innerHTML = relacionesHtml;
        }

        document.addEventListener('DOMContentLoaded', function () {
            cargarListas();

            // Persona
            document.getElementById('personaForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const ci = this.ci.value;
                const nombre = this.nombre.value;
                const es_funcionario = document.getElementById('funcionarioCheck').checked;
                if (es_funcionario) {
                    // Crear persona y abrir modal
                    const res = await fetch('/personas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ci, nombre })
                    });
                    personaTemp = await res.json();
                    abrirModal('modalFuncionario');
                } else {
                    await fetch('/personas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ci, nombre })
                    });
                    window.location.reload();
                }
            });
            window.guardarFuncionario = async function () {
                const numero_credencial = document.getElementById('modal_numero_credencial').value;
                if (personaTemp && numero_credencial) {
                    await fetch('/funcionarios_publicos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            persona_id: personaTemp.id,
                            numero_credencial
                        })
                    });
                }
                cerrarModal('modalFuncionario');
                window.location.reload();
            }

            // Usuario
            document.getElementById('usuarioForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const nombre = this.nombre.value;
                const rol = this.rol.value;
                await fetch('/usuarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, rol })
                });
                window.location.reload();
            });

            // Vehículo
            document.getElementById('vehiculoForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const numero_crasis = this.numero_crasis.value;
                const placa = this.placa.value;
                const tipo = this.tipo.value;
                const es_institucional = document.getElementById('institucionalCheck').checked;
                if (es_institucional) {
                    // Crear vehículo y abrir modal
                    const res = await fetch('/vehiculos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ numero_crasis, placa, tipo })
                    });
                    vehiculoTemp = await res.json();
                    abrirModal('modalInstitucional');
                } else {
                    await fetch('/vehiculos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ numero_crasis, placa, tipo })
                    });
                    window.location.reload();
                }
            });
            window.guardarInstitucional = async function () {
                const nombre_institucion = document.getElementById('modal_nombre_institucion').value;
                if (vehiculoTemp && nombre_institucion) {
                    await fetch('/vehiculos_institucionales', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            vehiculo_id: vehiculoTemp.id,
                            nombre_institucion
                        })
                    });
                }
                cerrarModal('modalInstitucional');
                window.location.reload();
            }

            // Estación
            document.getElementById('estacionForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const nombre = this.nombre.value;
                const ubicacion = this.ubicacion.value;
                await fetch('/estaciones', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, ubicacion })
                });
                window.location.reload();
            });

            // Asociar persona a vehículo
            document.getElementById('asociarForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const persona_id = document.getElementById('asociar_persona').value;
                const vehiculo_id = document.getElementById('asociar_vehiculo').value;
                const res = await fetch('/personas_vehiculos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({persona_id, vehiculo_id})
                });
                if (res.status !== 201) {
                    const data = await res.json();
                    document.getElementById('asociarError').innerText = data.error || 'Error';
                } else {
                    document.getElementById('asociarError').innerText = '';
                    cargarListas();
                }
            });
        });
    </script>
</body>
</html>